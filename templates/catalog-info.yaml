apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: projeto-infra
  title: SolicitaÃ§Ã£o de Projeto de Infraestrutura
  description: Template para solicitar projeto com recursos
spec:
  type: infrastructure
  owner: equipe-devops
  parameters:
    - title: InformaÃ§Ãµes do Projeto
      required:
        - nomeProjeto
        - usuario
        - email
        - area
        - site
      properties:
        nomeProjeto:
          title: Nome do Projeto
          type: string
        usuario:
          title: Nome do UsuÃ¡rio
          type: string
        email:
          title: E-mail
          type: string
          format: email
        area:
          title: Ãrea
          type: string
          enum:
            - Infraestrutura
            - Desenvolvimento
            - OperaÃ§Ãµes
            - Dados
            - SeguranÃ§a
        site:
         title: Site
         type: string
         ui:field: CustomSiteField


    - title: Recursos NecessÃ¡rios
      required: [cpu, memoria, disco]
      properties:
        cpu:
          title: CPU (cores)
          type: number
          minimum: 1
        memoria:
          title: MemÃ³ria (GB)
          type: number
          minimum: 1
        disco:
          title: Disco (GB)
          type: number
          minimum: 1
        readWriteMany:
          title: Precisa de mÃºltipla escrita (ReadWriteMany)?
          type: boolean
          default: false

    - title: OrÃ§amento
      required:
        - idOrcamento
        - megaProjeto
        - acaoInversora
      properties:
        idOrcamento:
          title: ID OrÃ§amentÃ¡rio
          type: string
        megaProjeto:
          title: Mega Projeto (Diretoria)
          type: string
        acaoInversora:
          title: AÃ§Ã£o Inversora
          type: string

    - title: ConfirmaÃ§Ã£o
      required:
        - confirmarCriacao
      properties:
        custoSimulado:
          title: ğŸ’° Custo Estimado
          type: string
          default: "R$25"
          readOnly: true
        confirmarCriacao:
          title: Confirmar criaÃ§Ã£o do projeto?
          type: boolean

  steps:
    - id: verificar-confirmacao
      name: Verificar ConfirmaÃ§Ã£o
      action: debug:log
      input:
        message: |
          ${{
            parameters.confirmarCriacao
              ? "âœ… UsuÃ¡rio confirmou criaÃ§Ã£o. Prosseguindo..."
              : "ğŸš« UsuÃ¡rio NÃƒO confirmou. Template serÃ¡ encerrado."
          }}

    - id: criar-ticket
      name: Criar Ticket no Jira
      if: ${{ parameters.confirmarCriacao }}
      action: custom:jira:createTicket
      input:
        projectKey: ZT
        issueType: Task
        summary: "[Infra] SolicitaÃ§Ã£o: ${{ parameters.nomeProjeto }}"
        description: |
          ğŸ“ SolicitaÃ§Ã£o de Infraestrutura criada via Backstage:

          ğŸ“Œ Projeto: ${{ parameters.nomeProjeto }}
          ğŸ‘¤ Solicitante: ${{ parameters.usuario }} - ${{ parameters.email }}
          ğŸ¢ Ãrea: ${{ parameters.area }}

          ğŸ“ Site: ${{ parameters.site }}
          ${{
            parameters.site == "Outro"
              ? "ğŸ“« EndereÃ§o: " + parameters.siteOutroEndereco + "\nğŸ“„ Justificativa: " + parameters.siteOutroJustificativa
              : ""
          }}

          âš™ï¸ Recursos:
          - CPU: ${{ parameters.cpu }}
          - MemÃ³ria: ${{ parameters.memoria }}
          - Disco: ${{ parameters.disco }} GB
          - RWX: ${{ parameters.readWriteMany }}

          ğŸ’° OrÃ§amento:
          - ID: ${{ parameters.idOrcamento }}
          - Mega Projeto: ${{ parameters.megaProjeto }}
          - AÃ§Ã£o Inversora: ${{ parameters.acaoInversora }}

          âœ… SolicitaÃ§Ã£o confirmada pelo usuÃ¡rio.

  output:
    text:
      - title: SolicitaÃ§Ã£o enviada com sucesso!
        content: |
          A abertura de demanda foi realizada e o ticket foi criado no Jira com os dados fornecidos.
