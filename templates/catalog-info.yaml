apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: projeto-infra
  title: Solicita√ß√£o de Projeto de Infraestrutura
  description: Template para solicitar projeto com recursos
spec:
  type: infrastructure
  owner: equipe-devops
  parameters:
    - title: Informa√ß√µes do Projeto
      required:
        - nomeProjeto
      properties:
        nomeProjeto:
          title: Nome do Projeto
          type: string
          description: Nome identificador do projeto

    - title: Recursos do Projeto
      required:
        - memoria
        - cpu
      properties:
        memoria:
          title: Quantidade de Mem√≥ria
          type: string
          enum:
            - "2Gi"
            - "4Gi"
            - "8Gi"
          enumNames:
            - "2 GB"
            - "4 GB"
            - "8 GB"
          description: Escolha a quantidade de mem√≥ria
        cpu:
          title: Quantidade de CPU
          type: string
          enum:
            - "1"
            - "2"
            - "4"
          enumNames:
            - "1 vCPU"
            - "2 vCPU"
            - "4 vCPU"
          description: Escolha a quantidade de CPU

    - title: Confirma√ß√£o e Custo
      description: Confirme a cria√ß√£o do projeto com base no custo estimado.
      required:
        - confirmarCriacao
      properties:
        custoEstimado:
          title: Custo Estimado
          type: string
          ui:field: CustoEstimado
          readOnly: true
          description: Valor calculado dinamicamente com base na mem√≥ria e CPU.
        confirmarCriacao:
          title: Confirmar cria√ß√£o do projeto?
          type: boolean
          description: Marque para prosseguir com a solicita√ß√£o.

  steps:
    - id: calcular-custo
      name: Calcular Custo Estimado
      action: debug:log
      input:
        message: |
          üîç C√°lculo de custo estimado:
          - CPU: ${{ parameters.cpu }} x R$1 = R$${{ parameters.cpu }}
          - Mem√≥ria: ${{ parameters.memoria }} x R$3

          üí∞ Total estimado: R$${{ parameters.cpu | parseInt | multiply(1) + (parameters.memoria | replace("Gi", "") | parseInt | multiply(3)) }}

    - id: verificar-confirmacao
      name: Verificar Confirma√ß√£o
      action: debug:log
      input:
        message: |
          ${{
            parameters.confirmarCriacao
              ? "‚úÖ Usu√°rio confirmou cria√ß√£o. Prosseguindo..."
              : "üö´ Usu√°rio N√ÉO confirmou. Template ser√° encerrado."
          }}

    - id: criar-ticket
      name: Criar Ticket no Jira
      if: ${{ parameters.confirmarCriacao }}
      action: custom:jira:createTicket
      input:
        projectKey: ZT
        issueType: Task
        summary: "[Infra] Solicita√ß√£o de Projeto: ${{ parameters.nomeProjeto }}"
        description: |
          Solicita√ß√£o de projeto criada via Backstage:
          - Projeto: ${{ parameters.nomeProjeto }}
          - Mem√≥ria: ${{ parameters.memoria }}
          - CPU: ${{ parameters.cpu }}
          - üí∞ Custo estimado: R$${{ parameters.cpu | parseInt | multiply(1) + (parameters.memoria | replace("Gi", "") | parseInt | multiply(3)) }}

  output:
    text:
      - title: Resultado
        content: |
          ‚úÖ Solicita√ß√£o criada com sucesso!

          üì¶ Detalhes:
          - Projeto: ${{ parameters.nomeProjeto }}
          - Mem√≥ria: ${{ parameters.memoria }}
          - CPU: ${{ parameters.cpu }}
          - üí∞ Custo estimado: R$${{ parameters.cpu | parseInt | multiply(1) + (parameters.memoria | replace("Gi", "") | parseInt | multiply(3)) }}

          Obrigado por utilizar o Backstage!
